name: CI/CD â†’ EC2

# æ¨é€ main åˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches: [main]

env:
  IMAGE_NAME: focus-pomodoro-timer

jobs:
  # â”€â”€ Job 1: æ„å»º + E2E æµ‹è¯• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci:
    name: Build & E2E
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check + Vite build
        run: npm run build

      - name: Run Cypress E2E (headless)
        # start-server-and-test: preview â†’ cypress run
        run: npm run e2e

      - name: Upload Cypress screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots

  # â”€â”€ Job 2: Docker build â†’ SCP â†’ SSH deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Docker Build & Deploy
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build \
            -t $IMAGE_NAME:${{ github.sha }} \
            -t $IMAGE_NAME:latest \
            .

      - name: Save image to tarball
        run: docker save $IMAGE_NAME:${{ github.sha }} | gzip > image.tar.gz

      # â”€â”€ éœ€è¦é…ç½®çš„ GitHub Secretsï¼ˆè§ READMEï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # EC2_HOST     : EC2 å…¬ç½‘ IP æˆ–åŸŸå
      # EC2_USER     : SSH ç”¨æˆ·ï¼Œå¦‚ ubuntu / ec2-user
      # EC2_SSH_KEY  : ç§é’¥å†…å®¹ï¼ˆPEM æ ¼å¼ï¼Œå³ ~/.ssh/xxx.pem çš„å…¨æ–‡ï¼‰

      - name: SCP image to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: image.tar.gz
          target: ~/deploy/

      - name: SSH deploy container on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ~/deploy

            echo "ğŸ“¦ Loading Docker image..."
            docker load < image.tar.gz

            echo "ğŸ”„ Replacing container..."
            docker stop ${{ env.IMAGE_NAME }} 2>/dev/null || true
            docker rm   ${{ env.IMAGE_NAME }} 2>/dev/null || true

            docker run -d \
              --name ${{ env.IMAGE_NAME }} \
              --restart unless-stopped \
              -p 80:80 \
              ${{ env.IMAGE_NAME }}:${{ github.sha }}

            echo "ğŸ§¹ Pruning old images..."
            docker image prune -f

            echo "âœ… Deploy done. Checking health..."
            sleep 5
            curl -sf http://localhost/ | head -c 100 && echo ""
